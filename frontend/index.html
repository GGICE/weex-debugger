<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="assets/entry.css">
    <link rel="stylesheet" href="assets/toast.css">
    <script src="lib/toast.js"></script>
    <script src="vendor/qrcode.min.js"></script>
    <script src="lib/locale.js"></script>
    <script src="lib/i18n.js"></script>
</head>
<body>
<div class="ctn">
    <div class="logo">
        <img src="assets/logo.svg" alt="">
    </div>
    <div class="qrcode-wrap loading-state">
        <div class="qrcode-ctn">
            <div id="qrcode"></div>

        </div>
        <div class="loading-ctn">
            <div class="loading">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>
    <div class="description i18n">
        <b>${SCAN}</b> ${OR} <b>${CLICK}</b> ${TIPS}<span class="new" title="open a new instance">+</span>

        <div class="scan-tips"> ${SCAN_TIPS}</div>
    </div>
    <div class="version i18n">${VERSION}
        <div class="click-tips" >${CLICK_TIPS}</div>
    </div>

</div>
<div class="mask"></div>
<div class="help">?</div>
</body>
<script>
    var maxReconnectCount = 10
    var websocket
    var channelId
    var connectUrl
    connect()
    function send(message) {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            websocket.send(JSON.stringify(message))
        }
    }
    function connect() {
        websocket = new WebSocket('ws://' + location.host + '/page/entry')


        if (location.hash === '#new') {
            //new page disable get channelId from sessionStorage
            location.hash = ''
        }
        else {
            channelId = sessionStorage.getItem('channelId')
            connectUrl = sessionStorage.getItem('connectUrl')
        }

        websocket.onopen = function () {

            if (channelId) {
                initQrcode()
            }
            else {
                send({method: 'WxDebug.applyChannelId'})
            }
        }
        websocket.onmessage = function (event) {
            var message = JSON.parse(event.data)
            if (message.method == 'WxDebug.pushChannelId') {
                channelId = message.params.channelId
                connectUrl = message.params.connectUrl
                sessionStorage.setItem('channelId', channelId)
                sessionStorage.setItem('connectUrl', connectUrl)
                initQrcode()
            }
            else if (message.method == 'WxDebug.startDebugger') {

                if (channelId === message.params) {
                    sessionStorage.removeItem('channelId')
                    sessionStorage.removeItem('connectUrl')
                    location.href = '/debug.html?channelId=' + message.params
                }
            }
            else if (message.method == 'WxDebug.prompt'&&channelId === message.params.channelId) {
                var delayed = 5000 + message.params.messageText.length / 6 * 1000
                toast(message.params.messageText.replace(/\n/g, '<br>'), delayed)

            }
        }
        websocket.onclose = function () {
            sessionStorage.removeItem('channelId')
            sessionStorage.removeItem('connectUrl')
            document.getElementById('qrcode').innerHTML = ''
            document.querySelector('.qrcode-wrap').className += '  loading-state'
            if (maxReconnectCount-- > 0) {
                setTimeout(connect, 3000)
            }
        }
    }

    function createQRCode(channelId, connectUrl) {
        document.getElementById('qrcode').innerHTML = ''
        new QRCode(document.getElementById('qrcode'), {
            text: connectUrl || `http:\/\/${location.host}/devtool_fake.html?_wx_devtool=ws:\/\/${location.host}/debugProxy/native/` + channelId,
            width: 200,
            height: 200,
            colorDark: "#000000",
            colorLight: "#E0E0E0",
            correctLevel: QRCode.CorrectLevel.L
        })


    }
    document.querySelector('.new').onclick = function () {
        window.open(location.href.replace(/#.*$|$/, '#new'), '_blank')
    }
    var loadingSimulator=false
    document.querySelector('#qrcode').onclick = function () {
        if (channelId&&!loadingSimulator) {
            loadingSimulator=true
            document.querySelector('.qrcode-wrap').className += '  loading-state'
            if(navigator.platform=='MacIntel') {
                send({method: 'WxDebug.simrun', params: channelId})
                //toast('starting simulator... ',10000)
            }
            else{
                toast('Just support ios simulator now!',5000)
            }

        }
    }


    document.querySelector('.help').onclick = function () {
        if (document.querySelector('.help').innerHTML === '?') {
            document.querySelector('.help').innerHTML = 'x'
            document.querySelector('.mask').style.animation = 'expand 0.6s ease 1 forwards'
            document.querySelector('.description b:nth-child(1)').style.animation = 'blink 0.3s ease 1.1s 2'
            document.querySelector('.description b:nth-child(2)').style.animation = 'blink-and-translate 1s ease 1.1s 1 forwards'
            document.querySelector('.scan-tips').style.animation = 'show 0.3s linear 2.1s 1 forwards'
            document.querySelector('.click-tips').style.animation = 'show 0.3s linear 2.1s 1 forwards'
        }
        else {
            document.querySelector('.help').innerHTML = '?'
            document.querySelector('.mask').style.animation = 'collapse 0.6s ease 1'
            document.querySelector('.description b:nth-child(1)').style.animation = ''
            document.querySelector('.description b:nth-child(2)').style.animation = ''
            document.querySelector('.scan-tips').style.animation = ''
            document.querySelector('.click-tips').style.animation = ''

        }
    }
    var notFirst = localStorage.getItem('notFirst')
    if (!notFirst) {
        setTimeout(function () {
            document.querySelector('.help').onclick()
        }, 1000)


        localStorage.setItem('notFirst', '1')
    }
    function initQrcode() {
        createQRCode(channelId, connectUrl)
        setTimeout(function(){
            document.querySelector('.qrcode-wrap').className='qrcode-wrap'
        },800)
    }
</script>
</html>